# 加密与压缩

## 目录
1. [用户视角的应用](#1-用户视角的应用)
2. [程序概览](#2-程序概览)
3. [程序结构初步设计](#3-程序结构初步设计)
   - [3.1 程序结构及要点](#31-程序结构及要点)
   - [3.2 初步设计](#32-初步设计)
4. [底层细节与技术](#4-底层细节与技术)
   - [4.1 技术整合与分析](#41-技术整合与分析)
   - [4.2 关键技术点](#42-关键技术点)
5. [算法具体实现](#5-算法具体实现)
   - [5.1 实现方案](#51-实现方案)
   - [5.2 疑难问题的解决方案](#52-疑难问题的解决方案)
   - [5.3 优化与改进](#53-优化与改进)
6. [安全问题](#6-安全问题)
   - [6.1 Aes的安全性问题](#61-aes的安全性问题)
   - [6.2 数据完整性问题](#62-数据完整性问题)
   - [6.3 系统安全考虑](#63-系统安全考虑)
7. [最终实现](#7-最终实现)
   - [7.1 程序的运行流程](#71-程序的运行流程)

## 1. 用户视角的应用
- 见"策划.md"

## 2. 程序概览
- 见"策划.md"

## 3. 程序结构初步设计

### 3.1 程序结构及要点

**Compress/Decompress_System**  
负责压缩与解压。  

**Encryption/Decryption_System**  
负责加密与解密工作。

**BufferPool**  
- 缓存以上两者的输出（通信缓存池、打包缓存池）
- 充当可接受线程管理器动态调度的对象
- 每个线程组独立使用一个缓存池
- 加入大小限制和溢出处理机制
- 充当接收输入并缓存/主动抛出的作用



**ErrorCollector**  
负责对错误的检测与收集，生成并且输出相关错误报告(日志)

### 3.2 初步设计

**Encryption**  
技术点(适配技术)：
1. 密钥hash处理
2. 尾部补全与去除
3. 缓存池
(全部已完成)

**Compression**  
1. 继承一个缓存池接口，以二进制抛出数据块
2. (待补充)
3. (待补充)

**UnitManager**
示意：Heffman-(1)>Aes-(2)>.sy文件(实际为二进制)
1. 虚拟接口类的设计：

**GUI**  
设计GUI：
- I：多线程模式选择(后续自动检测)
- II：加密、压缩算法切换
- III：引入已加密的标记与加密文件的自动识别、提示输入密码
**BufferPool**
- 关于通信缓存池：压缩与加密端之间的通信。依赖于文件头包含的顺序标签（保证按序组合）以及终止信号（抛出）
- 关于打包缓存池：打包压缩单独输出、压缩加密输出（利用文件头区分。可能分别设计两类输入接口，或直接继承加密输出端口）
- 多文件打包：需要一个文件目录传输方法，将目录存放到文件头以配合文件分割标志，用于目录的还原。

- 数据块（struct）：
-   '''
    vector<uint8_t> data    // 数据（二进制）
    uint32_t sequence_tag   // 顺序标签
    bool is_terminated      // 终止信号
    uint8_t header_flags    // 文件头标志位
    string source_tag       // 来源标签（如"COMPRESS", "AES"）
    string error_message    // 错误信息
    '''

**Optimization**  
优化：
- **Aes：**
  * I：多线程：可能使用文件分割，需要注意内存和线程数检测
  * II：需要引入id标记分块文件，以便整合为文件输出
  * III：指令集加速(aes提速、heffman提速、LZ77提速)
- **Heffman：**
  * I：多线程，部分同Aes
- **BufferPool：**
  * I：多线程流水线
  * II：防溢出
- **UnitManager**
- 管理模块（分割文件并分配，需要传输各自的组合顺序标签）
- 后续会拥有独立的多线程打包缓存池，负责打包各个打包缓存池的数据

## 4. 底层细节与技术

### 4.1 技术整合与分析
主要技术：
- **加密：**
  * aes-128
- **压缩：**
  * heffman
- **控制：**
  * thread/buffer
- **文件**
  * .sy
分析：
- **加密：**
  * aes-128：128bit密钥，十轮处理。
- **压缩：**
  * heffman基于自然语言重复性的压缩算法
- **控制：**
  * thread/buffer:
    - 线程与线程、模块与缓存池之间的组合与调度
- **文件**
  * 可借鉴7z：
```          
      [ 文件头 (固定16字节) ]
      ├─ Magic:         0x2E 0x73 0x79 0x1A (".sy\x1A")
      ├─ Version:       0x01 0x00 (小端)
      ├─ Flags:         0xC5 (二进制 11000101)
      │                  ││││││└─ 保留位
      │                  │││││└── 含文件属性
      │                  ││││└─── 含时间戳  
      │                  │││└──── 分块文件
      │                  ││└───── 多文件包
      │                  │└────── 使用压缩
      │                  └─────── 已加密
      └─ Header CRC:    0x78 0x56 0x34 0x12

      [ 扩展头（可变长度） ]
      ├─ [压缩头] (存在当Flags.bit2=1)
      │  ├─ AlgorithmID: 0x01 (Huffman=0x01,LZMA=0x02)
      │  └─ DictSize:    0x00 0x40 0x00 0x00 (16MB)
      │
      ├─ [加密头] (存在当Flags.bit7=1)
      │  ├─ Method:      0x02 (AES-256-CBC)
      │  ├─ KDFIterLog:  0x10 (迭代次数=2^16)
      │  ├─ SaltSize:    0x10
      │  └─ Salt:        16字节随机值
      │
      ├─ [文件清单] (存在当Flags.bit5=1)
      │  ├─ FileCount:   0x02 0x00 (2个文件)
      │  ├─ [FileMeta1]  结构体含文件名
      │  └─ [FileMeta2]
      │
      ├─ [分块信息] (存在当Flags.bit3=1)
      │  ├─ BlockCount:  0x03 0x00 0x00 0x00
      │  └─ BlockSizes:  [8字节×3]
      │
      └─ HeaderEndMark: 0xFF 0xFF

      [ 数据区 ]
      ├─ [块1]
      │  ├─ CompressedSize:   8字节
      │  ├─ OriginalSize:     8字节
      │  └─ Data:             N字节密文
      ├─ [块2]...
      └─ [块n]
```
### 4.2 关键技术点
- 线程间通信机制设计
- 缓冲区数据同步方案
- 加密压缩的顺序化处理
- 异常处理和恢复机制

## 5. 算法具体实现

### 5.1 实现方案
- **Aes加密实现：**
  * PKCS#7填充方案
  * 密钥派生函数处理用户密码
- **Heffman压缩实现：**
  * 基于频率统计的编码
  * 并行化文件处理
- **线程控制方案**

### 5.2 疑难问题的解决方案
- 加密压缩顺序问题：
  * 采用先压缩后加密的标准流程
- 大数据处理：
  * 引入分块处理机制
- 性能瓶颈：
  * 动态调整线程池大小
- 内存管理：
  * 限制缓冲区最大尺寸

### 5.3 优化与改进
- **性能优化：**
  * SIMD指令加速
- **功能扩展：**
  * 支持多种加密算法
  * 增加压缩算法选择
- **用户体验：**
  * 进度显示优化
  * 错误信息友好化

## 6. 安全问题

### 6.1 Aes的安全性问题
- 密钥管理方案设计
- 加密模式选择分析

### 6.2 数据完整性问题
- 校验和机制
- 防篡改设计

### 6.3 系统安全考虑
- 内存敏感数据清理
- 临时文件安全处理
- 权限最小化原则

## 7. 最终实现

### 7.1 程序的运行流程
1. 用户通过GUI选择操作模式(加密/解密、压缩/解压)
2. 选择输入文件和输出路径
3. 输入必要参数(如密码)
4. ThreadManager初始化处理线程
5. 文件分块进入处理流水线
6. 加密/压缩顺序处理
7. 结果写入输出文件
8. 错误处理和日志记录
9. 内存清理和资源释放
